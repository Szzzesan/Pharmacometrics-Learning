---
title: "Foundations of Population Modeling (Month 2, Week 5)"
output:
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
# This chunk sets up the libraries we'll need for the plots.
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center')
library(ggplot2)
library(deSolve)
library(DiagrammeR)
```

### **1. üåç What is Population Modeling?**

Population Pharmacokinetic (PopPK) analysis is a quantitative method used to study drug concentrations at the population level.

Instead of just finding the "average" PK, its primary goals are:
1.  **Describe** the typical concentration-time course for a drug.
2.  **Quantify** the variability in drug concentrations among individuals.
3.  **Explain** that variability by identifying specific patient characteristics, or **covariates**.

This variability can come from **intrinsic factors** (like body weight or genetics) or **extrinsic factors** (like other medications).

### **2. üèóÔ∏è Core Concepts: Mixed-Effects & Hierarchies**

These models are called **Mixed-Effects Models** because they "mix" or combine both fixed and random effects.

This approach is necessary because our data has a **hierarchical (or nested) structure**. The tutorial by Mould & Upton (Part 1) explains that variability is partitioned into multiple levels:

-   **Level 1 (Top): Population** (The entire group)
-   **Level 2 (Middle): Subjects** (Individuals within the population)
-   **Level 3 (Bottom): Observations** (The repeated, longitudinal measurements *within* each subject)

### **3. üìà The Mathematical Components of a PopPK Model**

Let's build a simple model for a drug's Clearance (CL) to see how the math works.

#### **A. Fixed Effects (The Average)**

These are parameters that represent the **population's typical value** (or central tendency) for a parameter.
-   **Notation:** In NONMEM, these are called **THETAs ($\theta$)**.
-   **Example Equation:**
    $$ Typical_{CL} = \theta_1 $$
    Here, $\theta_1$ represents the average Clearance (e.g., 10 L/hr) for the whole population.

#### **B. Random Effects (The Variability)**

These parameters describe the random, unexplainable variability. This variability is split into two types:

**1. Between-Subject Variability (BSV)**
This quantifies the differences *between* subjects. It describes how an individual's parameter (e.g., your CL) deviates from the population's typical value.

-   **Notation:** The random variable for each subject is **ETA ($\eta$)**. The variance of the ETAs (how wide the distribution is) is **OMEGA ($\omega^2$)**.
-   **Example Equation:** We often assume a log-normal distribution for PK parameters (meaning the parameter must be positive).
    $$ Individual_{CL} = Typical_{CL} \cdot e^{\eta_1} $$
    Or, using our THETA:
    $$ Individual_{CL} = \theta_1 \cdot e^{\eta_1} $$
    Here, $\eta_1$ is the random value for a specific subject. An $\eta$ of 0 means the person is typical. A positive $\eta$ means their clearance is higher than average, and a negative $\eta$ means it's lower.

**2. Residual Variability**
This is the "noise" or variability left over. It describes the difference between an individual's *actual measured observation* (the dot on the graph) and their *own* predicted curve. It accounts for things like lab measurement error or minor biological fluctuations.

-   **Notation:** The random variable for each observation is **EPSILON ($\epsilon$)**. The variance of the EPSILONs is **SIGMA ($\sigma^2$)**.
-   **Example Equation:** We can model this in a few ways. A common way is a **proportional error model**, which assumes the error is proportional to the concentration.
    $$ Y = C_{pred} + C_{pred} \cdot \epsilon_1 $$
    Where:
    -   $Y$ is the final measured concentration.
    -   $C_{pred}$ is the model's prediction for that individual at that specific time.
    -   $\epsilon_1$ is the random error for that specific measurement.

#### **Example Plot: Visualizing the Model Components**
This plot shows how all three components work together.
-   The **Black Line** is the **Fixed Effect** (the "Typical Subject" or $\theta$).
-   The **Colored Lines** are different **Individual Subjects**, each with their own **Random Effect** (their $\eta$).
-   The **Points** are the **Observations**, which are scattered around each individual's line by the **Residual Error** (their $\epsilon$).

```{r variability_plot, echo=FALSE}
# --- Code for Variability Plot ---
# Population parameters
typical_c0 <- 100 # THETA(1)
typical_ke <- 0.2  # THETA(2)
omega_ke <- 0.25   # Variance (omega^2) for ke
sigma <- 0.1       # SD (sigma) for residual error

# Simulate data
set.seed(123)
n_subjects <- 6
subjects <- 1:n_subjects
times <- c(0, 1, 2, 4, 8, 12, 24)

# Create random effects (ETAs) for each subject
etas <- rnorm(n_subjects, mean = 0, sd = sqrt(omega_ke))

# Create a data frame to hold all data
sim_data <- data.frame()

# Loop through each subject
for (i in subjects) {
  # Calculate individual parameter
  individual_ke <- typical_ke * exp(etas[i])
  
  # Generate predicted concentrations for this individual
  pred_conc <- typical_c0 * exp(-individual_ke * times)
  
  # Add residual error (EPSILONs) to get final observations
  # Y = C_pred + C_pred * EPSILON
  obs_conc <- pred_conc + pred_conc * rnorm(length(times), mean = 0, sd = sigma)
  
  # Add to our data frame
  sim_data <- rbind(sim_data, data.frame(
    Time = times,
    Pred_Conc = pred_conc,
    Obs_Conc = obs_conc,
    Subject = as.factor(i)
  ))
}

# Create a data frame for the population ("fixed effect") line
pop_data <- data.frame(
  Time = seq(0, 24, by = 0.1),
  Concentration = typical_c0 * exp(-typical_ke * seq(0, 24, by = 0.1)),
  Subject = "Population"
)

# Plot!
ggplot(sim_data, aes(x = Time, y = Obs_Conc, group = Subject)) +
  # Plot the "Observations" (points)
  geom_point(aes(color = Subject), size = 3) +
  # Plot the "Individual Subject" lines (random effects)
  geom_line(aes(y = Pred_Conc, color = Subject), linewidth = 1) +
  # Plot the "Population" line (fixed effect)
  geom_line(data = pop_data, aes(y = Concentration), color = "black", linewidth = 1.5, linetype = "dashed") +
  scale_y_log10() +
  labs(title = "Visualizing a Mixed-Effects Model",
       subtitle = "Population vs. Individuals vs. Observations",
       x = "Time (hours)",
       y = "Concentration (mg/L) [Log Scale]") +
  annotate("text", x = 15, y = 70, label = "Population (Fixed Effect, THETA)", color = "black") +
  annotate("text", x = 15, y = 2, label = "Individuals (Random Effect, ETA)", color = "blue4") +
  annotate("text", x = 5, y = 20, label = "Observations (Residual Error, EPSILON)", color = "red4") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")
```

### **4. üéØ Covariates: Explaining the Variability**

The main goal of PopPK is to *explain* the **Between-Subject Variability (BSV)**. We do this by finding **covariates**‚Äîmeasurable characteristics like age, body weight, or genetics‚Äîthat predict *why* a subject's $\eta$ might be high or low.

-   **Example Equation:** We can update our `Typical_CL` equation to include a covariate. A common model for body weight is an allometric power model:
    $$ Typical_{CL} = \theta_1 \cdot \left( \frac{Patient\_Weight}{70} \right)^{\theta_2} $$
    Here:
    -   $\theta_1$ is the typical CL for a 70kg person.
    -   $\theta_2$ is a new fixed effect that describes the *strength* of the relationship between weight and CL.

By adding this covariate, we've *explained* some of the variability. The remaining *unexplained* BSV (the $\eta$ value) will now be smaller.

### **5. üìö References**

-   **FDA Guidance (2022):**
    -   Purpose of PopPK: p. 2, Section II
    -   Intrinsic/Extrinsic Factors: p. 2, Section II
    -   Specific Populations (Covariates): p. 6, Section III.B.1
    
-   **Owen & Fiedler-Kelly (2014):**
    -   Fixed Effects (THETAs): p. 13, Section 2.4.1
    -   Random Effects (ETAs): p. 14, Section 2.4.2.1
    -   OMEGA: p. 14, Section 2.4.2.1
    -   Residual Variability (EPSILONs): p. 15, Section 2.4.2.2
    -   SIGMA: p. 15, Section 2.4.2.2
    -   Covariate Example (Allometry): p. 6, Section 1.4
    -   Model Building Process (Covariates): Chapter 5, p. 90+
    
-   **Mould & Upton, Part 1 (2012):**
    -   Hierarchies/Levels: p. 4, "Stochastic models for random effects"
    -   Fixed Effects (THETA): p. 4
    -   Random Effects (ETA): p. 5
    -   OMEGA: p. 5
    -   Residual Error (EPSILON): p. 5
    -   SIGMA: p. 5
    -   Covariates: p. 5, "Covariate models for fixed effects"
    -   PKPD Models: p. 3, "PKPD models"

-   **Mould & Upton, Part 2 (2013):**
    -   Sources of Variability (BSV & Residual): p. 5, "STATISTICAL MODELS"
    -   Log-normal model for BSV: p. 5, "BSV" section, Eq. 5
    -   Proportional Error Model: p. 8, Table 1
    -   Covariate Models: p. 9, "COVARIATE MODELS"
    -   Allometric Scaling (Power Model): p. 11, Eq. 21